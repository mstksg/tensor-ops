<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE DataKinds              #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE DeriveFunctor          #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE EmptyCase              #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts       #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE GADTs                  #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE InstanceSigs           #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# LANGUAGE KindSignatures         #-}</span><span>
</span><a name="line-8"></a><span class="hs-pragma">{-# LANGUAGE LambdaCase             #-}</span><span>
</span><a name="line-9"></a><span class="hs-pragma">{-# LANGUAGE PolyKinds              #-}</span><span>
</span><a name="line-10"></a><span class="hs-pragma">{-# LANGUAGE RankNTypes             #-}</span><span>
</span><a name="line-11"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables    #-}</span><span>
</span><a name="line-12"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell        #-}</span><span>
</span><a name="line-13"></a><span class="hs-pragma">{-# LANGUAGE TypeApplications       #-}</span><span>
</span><a name="line-14"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies           #-}</span><span>
</span><a name="line-15"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilyDependencies #-}</span><span>
</span><a name="line-16"></a><span class="hs-pragma">{-# LANGUAGE TypeInType             #-}</span><span>
</span><a name="line-17"></a><span class="hs-pragma">{-# LANGUAGE TypeOperators          #-}</span><span>
</span><a name="line-18"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances   #-}</span><span>
</span><a name="line-19"></a><span>
</span><a name="line-20"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">BLAS</span><span>
</span><a name="line-21"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="TensorOps.BLAS.html#BShape"><span class="hs-identifier hs-type">BShape</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-22"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#BShapeDims"><span class="hs-identifier hs-type">BShapeDims</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#bShapeDims"><span class="hs-identifier hs-var">bShapeDims</span></a><span>
</span><a name="line-23"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#BShapeP"><span class="hs-identifier hs-type">BShapeP</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-24"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#bShapeProd"><span class="hs-identifier hs-var">bShapeProd</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#pbvProd"><span class="hs-identifier hs-var">pbvProd</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#pbmProd"><span class="hs-identifier hs-var">pbmProd</span></a><span>
</span><a name="line-25"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#BLAS"><span class="hs-identifier hs-type">BLAS</span></a><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Sing</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#SBShape"><span class="hs-identifier hs-type">SBShape</span></a><span>
</span><a name="line-28"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#elemsB"><span class="hs-identifier hs-var">elemsB</span></a><span>
</span><a name="line-29"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#zipB"><span class="hs-identifier hs-var">zipB</span></a><span>
</span><a name="line-30"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#bgen"><span class="hs-identifier hs-var">bgen</span></a><span>
</span><a name="line-31"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#bgenRows"><span class="hs-identifier hs-var">bgenRows</span></a><span>
</span><a name="line-32"></a><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-33"></a><span>
</span><a name="line-34"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Kind</span><span>
</span><a name="line-35"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span>
</span><a name="line-36"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">Prelude</span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Reverse</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Head</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sReverse</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-type">:-</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-37"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Singletons</span><span class="hs-operator">.</span><span class="hs-identifier">TH</span><span>
</span><a name="line-38"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Combinator</span><span>
</span><a name="line-39"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Product</span><span>              </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">TCP</span><span>
</span><a name="line-40"></a><span class="hs-keyword">import</span><span>           </span><a href="Data.Type.Sing.html"><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Sing</span></a><span>
</span><a name="line-41"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">VecT</span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Vec</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span class="hs-keyword">import</span><span>           </span><a href="TensorOps.NatKind.html"><span class="hs-identifier">TensorOps</span><span class="hs-operator">.</span><span class="hs-identifier">NatKind</span></a><span>
</span><a name="line-43"></a><span>
</span><a name="line-44"></a><span class="hs-operator">$</span><span class="hs-special">(</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">singletons</span></a><span> </span><span class="hs-special">[</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">d</span></a><span class="hs-glyph">|</span><span>
</span><a name="line-45"></a><span>  </span><span class="hs-keyword">data</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">BShape</span></a><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">BV</span></a><span> </span><span class="hs-glyph">!</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">|</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">BM</span></a><span> </span><span class="hs-glyph">!</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-glyph">!</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">a</span></a><span>
</span><a name="line-46"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">Show</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">Eq</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">Ord</span></a><span class="hs-special">,</span><span> </span><a href="TensorOps.BLAS.html#SBM"><span class="hs-identifier hs-var">Functor</span></a><span class="hs-special">)</span><span>
</span><a name="line-47"></a><span>  </span><span class="hs-glyph">|</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>
</span><a name="line-49"></a><span class="hs-keyword">type</span><span> </span><span class="hs-keyword">family</span><span> </span><a name="BShapeDims"><a href="TensorOps.BLAS.html#BShapeDims"><span class="hs-identifier">BShapeDims</span></a></a><span> </span><span class="hs-special">(</span><a name="local-1627604751"><a href="#local-1627604751"><span class="hs-identifier">s</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="TensorOps.BLAS.html#BShape"><span class="hs-identifier hs-type">BShape</span></a><span> </span><a href="#local-1627604750"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a name="local-1627604752"><a href="#local-1627604752"><span class="hs-identifier">ks</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><a href="#local-1627604750"><span class="hs-identifier hs-type">k</span></a><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-identifier">ks</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier">s</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-50"></a><span>    </span><span class="hs-identifier">BShapeDims</span><span> </span><span class="hs-special">(</span><span class="hs-char">'BV x  ) = '[x]
    BShapeDims ('BM x y) = '[x,y]

genDefunSymbols [''BShapeDims]

data BShapeP :: (k -&gt; Type) -&gt; BShape k -&gt; Type where
    PBV :: { unPBV :: !(f a) } -&gt; BShapeP f ('BV a)
    PBM :: { unPBMn :: !(f a)
           , unPBMm :: !(f b)
           } -&gt; BShapeP f ('BM a b)

bShapeProd
    :: BShapeP f s
    -&gt; Prod f (BShapeDims s)
bShapeProd = \case
    PBV x   -&gt; x :&lt; &#216;
    PBM x y -&gt; x :&lt; y :&lt; &#216;
{-# INLINE[0] bShapeProd #-}

{-# RULES
&quot;bShapeProd/BV&quot; bShapeProd = pbvProd
&quot;bShapeProd/BM&quot; bShapeProd = pbmProd
    #-}

pbvProd
    :: BShapeP f ('BV a)
    -&gt; Prod f '[a]
pbvProd (PBV x) = x :&lt; &#216;
{-# INLINE pbvProd #-}

pbmProd
    :: BShapeP f ('BM a b)
    -&gt; Prod f '[a,b]
pbmProd (PBM x y) = x :&lt; y :&lt; &#216;
{-# INLINE pbmProd #-}

bShapeDims :: BShape a -&gt; [a]
bShapeDims (BV x  ) = [x]
bShapeDims (BM x y) = [x,y]

class NatKind k =&gt; BLAS (b :: BShape k -&gt; Type) where
    type ElemB b :: Type
    liftB
        :: Sing s
        -&gt; (Vec n (ElemB b) -&gt; ElemB b)
        -&gt; Vec n (b s)
        -&gt; b s
    axpy
        :: ElemB b          -- ^ &#945;
        -&gt; b ('BV n)        -- ^ x
        -&gt; Maybe (b ('BV n))  -- ^ y
        -&gt; b ('BV n)        -- ^ &#945; x + y
    dot :: b ('BV n)        -- ^ x
        -&gt; b ('BV n)        -- ^ y
        -&gt; ElemB b          -- ^ x' y
    -- norm
    --     :: b ('BV n)        -- ^ x
    --     -&gt; ElemB b          -- ^ ||x||
    ger :: b ('BV n)        -- ^ x
        -&gt; b ('BV m)        -- ^ y
        -&gt; b ('BM n m)      -- ^ x y'
    gemv
        :: ElemB b          -- ^ &#945;
        -&gt; b ('BM n m)      -- ^ A
        -&gt; b ('BV m)        -- ^ x
        -&gt; Maybe (ElemB b, b ('BV n))        -- ^ &#946;, y
        -&gt; b ('BV n)        -- ^ &#945; A x + &#946; y
    -- TODO: better way to scale matrices
    gemm
        :: ElemB b          -- ^ &#945;
        -&gt; b ('BM n o)      -- ^ A
        -&gt; b ('BM o m)      -- ^ B
        -&gt; Maybe (ElemB b, b ('BM n m))      -- ^ &#946;, C
        -&gt; b ('BM n m)      -- ^ &#945; A B + &#946; C
    scaleB
        :: ElemB b
        -&gt; b s
        -&gt; b s
    addB :: b s -&gt; b s -&gt; b s
    indexB
        :: BShapeP (IndexN k) s
        -&gt; b s
        -&gt; ElemB b
    indexRowB
        :: IndexN k n
        -&gt; b ('BM n m)
        -&gt; b ('BV m)
    transpB
        :: b ('BM n m)
        -&gt; b ('BM m n)
    iRowsB
        :: Applicative f
        =&gt; (IndexN k n -&gt; b ('BV m) -&gt; f (b ('BV o)))
        -&gt; b ('BM n m)
        -&gt; f (b ('BM n o))
    iElemsB
        :: Applicative f
        =&gt; (BShapeP (IndexN k) s -&gt; ElemB b -&gt; f (ElemB b))
        -&gt; b s
        -&gt; f (b s)
    -- TODO: can we merge bgen and bgenRowsA?
    bgenA
        :: Applicative f
        =&gt; Sing s
        -&gt; (BShapeP (IndexN k) s -&gt; f (ElemB b))
        -&gt; f (b s)
    bgenRowsA
        :: (Applicative f, SingI n)
        =&gt; (IndexN k n -&gt; f (b ('BV m)))
        -&gt; f (b ('BM n m))
    eye :: Sing n
        -&gt; b ('BM n n)
    traceB
        :: b ('BM n n)
        -&gt; ElemB b
    diagB
        :: b ('BV n)
        -&gt; b ('BM n n)
    getDiagB
        :: b ('BM n n)
        -&gt; b ('BV n)
    sumB
        :: b s
        -&gt; ElemB b
    -- zero :: b s

elemsB
    :: (Applicative f, BLAS b)
    =&gt; (ElemB b -&gt; f (ElemB b))
    -&gt; b s
    -&gt; f (b s)
elemsB f = iElemsB (\_ x -&gt; f x)
{-# INLINE elemsB #-}

bgen
    :: forall k (b :: BShape k -&gt; Type) (s :: BShape k). BLAS b
    =&gt; Sing s
    -&gt; (BShapeP (IndexN k) s -&gt; ElemB b)
    -&gt; b s
bgen s f = getI $ bgenA s (I . f)
{-# INLINE bgen #-}

bgenRows
    :: (BLAS b, SingI n)
    =&gt; (IndexN k n -&gt; b ('BV m))
    -&gt; b ('BM n m)
bgenRows f = getI $ bgenRowsA (I . f)
{-# INLINE bgenRows #-}

zipB
    :: BLAS b
    =&gt; Sing s
    -&gt; (ElemB b -&gt; ElemB b -&gt; ElemB b)
    -&gt; b s
    -&gt; b s
    -&gt; b s
zipB s f x y = liftB s (\(I x' :* I y' :* &#216;V) -&gt; f x' y')
                       (I x :* I y :* &#216;V)
{-# INLINE zipB #-}
</span></pre></body></html>